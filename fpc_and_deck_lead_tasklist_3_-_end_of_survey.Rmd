---
title: "Tasklist at End of Survey"
site: distill::distill_website
---

```{r Subset Checklist documents for BS, echo = F, results="asis"}
checklist_items <- subset(x = full_site0, 
                          sub_page == "Tasklist 3 - End of Survey")
main_sections <- unique(checklist_items$section)

for (isection in main_sections) {
  subdf <- subset(x = checklist_items, subset = section == isection)
  duty_matrix <- matrix(data = "", 
                        nrow = 0, 
                        ncol = 8, 
                        dimnames = list(NULL, 
                                        c("Task", "FPC", 
                                          "Deck Lead", "Safety Lead",
                                          "EBS", "NBS", "AI", "GOA")))
  
  main_bullets <- unique(subdf$title)
  
  for(irow in 1:length(main_bullets)) {
    
    subdf2 <- subset(subdf, title == main_bullets[irow])
    temp_matrix <- matrix(data = "", 
                          nrow = 1, 
                          ncol = 8, 
                          dimnames = list(NULL, 
                                          c("Task", "FPC", 
                                            "Deck Lead", "Safety Lead",
                                            "EBS", "NBS", "AI", "GOA")))
    
    if (nrow(subdf2) == 1) {
      type <- ifelse(test = is.na(subdf2$url_loc),
                     yes = "text",
                     no = "link")
      
      
      temp_matrix[1, "Task"] <- paste0(irow, ") ", 
                                       ifelse(type == "link", yes = "[", no = ""),
                                       subdf2$title,
                                       ifelse(type == "link",
                                              yes = paste0("](",
                                                           subdf2$url_loc,
                                                           ")"),
                                              no = ""))
      
      for (duty in c("FPC", "Deck Lead", "Safety Lead")){
        duty_idx <- grep(x = subdf2$description_3, 
                         pattern = paste0("everyone|", duty))
        temp_matrix[duty_idx, duty] <- "X"
      } 
      
            which_region <- sapply(X = c("EBS", "NBS", "AI", "GOA", "all"),
                             FUN = function(xx) 
                               grepl(x = subdf2$Survey[1], pattern = xx) )
      if (which_region["all"] == TRUE)
        temp_matrix[, c("EBS", "NBS", "AI", "GOA")] <- "X"
      
      if (which_region["all"] == FALSE) 
        temp_matrix[, names(which_region)[which_region]] <- "X"
      
      
      duty_matrix <- rbind(duty_matrix, temp_matrix)
    }
    
    if (nrow(subdf2) > 1) { ## Requires one level of sub-bullets
      temp <- paste0(irow, ") ", main_bullets[irow], "\n")
      
      for (jrow in 1:nrow(subdf2)) {
        
        type <- ifelse(test = is.na(subdf2$url_loc[jrow]),
                       yes = "text",
                       no = "link")
        
        temp <- paste0(temp, "    - ", 
                       ifelse(type == "link", yes = "[", no = ""),
                       subdf2$subtitle[jrow],
                       ifelse(type == "link",
                              yes = paste0("](",
                                           subdf2$url_loc[jrow],
                                           ")"),
                              no = ""),
                       " \n ")
      }
      
      temp_matrix[1, "Task"] <- temp
      
      for (duty in c("FPC", "Deck Lead", "Safety Lead")){
        duty_idx <- grepl(x = unique(subdf2$description_3), 
                          pattern = paste0("everyone|", duty))
        if(duty_idx) temp_matrix[1, duty] <- "X"
      } 
      
            which_region <- sapply(X = c("EBS", "NBS", "AI", "GOA", "all"),
                             FUN = function(xx) 
                               grepl(x = subdf2$Survey[1], pattern = xx) )
      if (which_region["all"] == TRUE)
        temp_matrix[, c("EBS", "NBS", "AI", "GOA")] <- "X"
      
      if (which_region["all"] == FALSE) 
        temp_matrix[, names(which_region)[which_region]] <- "X"
            
      duty_matrix <- rbind(duty_matrix, temp_matrix)
    }
    
  }
  
  cat(paste0("\n# ", isection, " \n"))
  cat(kableExtra::add_header_above(kable_input = knitr::kable(duty_matrix, 
                                                              format = "html",
                                                              table.attr = "style='width:125%;'"),
                                   header = c(" " = 1, 
                                              "Duty" = 3, 
                                              "Survey" = 4)) )
}
```

